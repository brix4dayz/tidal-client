function map(){var e={lat:30.220552,lng:-91.600674},t=new google.maps.Map(document.getElementById("map"),{zoom:7,center:e,streetViewControl:!1})
$.getJSON(SERVER+"/locations",function(e){coordinates=e
for(var i in coordinates)markers[i]=new google.maps.Marker({position:coordinates[i].position,map:t,title:i,animation:google.maps.Animation.DROP})
for(var i in coordinates)google.maps.event.addListener(markers[i],"click",function(e){return function(){selectedKey!==e&&null!==selectedKey&&markers[selectedKey].setAnimation(null),null===markers[e].animation?(selectedKey=e,markers[e].setAnimation(google.maps.Animation.BOUNCE),document.getElementById("portSelection").innerHTML="<h3>You have selected: "+e+"</h3>"):(selectedKey=null,markers[e].setAnimation(null),document.getElementById("portSelection").innerHTML="<h3>Choose port by selecting a map pin:</h3>")}}(i))})}function requestTides(){if(context.clearRect(0,0,clearWidth,clearHeight),context.fillStyle="#ffffff",context.fillRect(0,0,clearWidth,clearHeight),context.fillStyle="#000000",context.font="18px Sans Serif",context.textAlign="left",context.fillText("Loading...",325,225),!requestCache[options.location+options.beginDate+options.endDate]){for(;Object.keys(requestCache).length>=CACHE_MAX;)console.log("Removing a cached request..."),delete requestCache[randomKey(requestCache)]
requestCache[options.location+options.beginDate+options.endDate]=$.ajax({type:"POST",url:SERVER+"/tides",contentType:"application/json",crossDomain:!0,data:JSON.stringify(options),dataType:"json"}).promise()}requestCache[options.location+options.beginDate+options.endDate].done(function(e,t,i){var n=JSON.parse(i.responseText)
tideData=n["soapenv:Envelope"]["soapenv:Body"][0].PredictionsAndMetadata[0].data[0].item,first=!0,stop=!1,getCanvas()}),requestCache[options.location+options.beginDate+options.endDate].fail(function(e){console.log("ERROR:",e)})}function getCanvas(){first&&(first=!1,resetTime()),updateDeltaTime(),stop?(tideData=null,options=null):(requestAnimationFrame(getCanvas),getMax(context,options,tideData))}function getMax(e,t,n){var a=.5,o=-.25
for(i in n)n[i].pred>a&&(a=Math.round(4*n[i].pred)/4+.25),n[i].pred<o&&(o=Math.round(4*n[i].pred)/4-.25)
drawAxis(e,t,n,a,o)}function drawAxis(e,t,i,n,a){var o=(n-a)/.25
e.clearRect(0,0,clearWidth,clearHeight)
for(var l=0;o>l;l++)l%2==0?e.fillStyle="#e8f8ff":e.fillStyle="#fbfdfb",e.fillRect(51,l*chartHeight/o+25,chartWidth,chartHeight/o)
var s=chartHeight*n/(.25*o)+25
e.beginPath(),e.moveTo(50,25),e.lineTo(50,chartHeight+25),e.moveTo(50,s),e.lineTo(chartWidth+50,s),e.lineWidth=2,e.strokeStyle="#092643",e.stroke(),plotData(e,t,i,chartHeight,chartWidth,s,o,n,a)}function plotData(e,t,i,n,a,o,l,s,r){var c=totalTime/PLOT_TIME
c>=1&&(c=1)
var d=c*i.length,p=i.length
e.strokeStyle="black",e.beginPath(),e.moveTo(51,o-4*i[0].pred*500/l),j=0,e.fillStyle="#a0abb6"
for(var g=0;d>g;g++)e.lineTo(a/p*j+51,o-4*i[g].pred*500/l),e.stroke(),e.fillRect(a/p*j+51,o-4*i[g].pred*500/l,3,4*i[g].pred*500/l-1),j++
labelAxis(e,t,i,s,r,n,l,o,a)}function labelAxis(e,t,i,n,a,o,l,s,r){e.fillStyle="#092643",e.font="17px Sans Serif",e.fillText("Feet",60,60),e.font="16px Sans Serif",e.textAlign="right",e.strokeStyle="#092643"
for(var c=0;n>=c;c+=.25)e.fillText(c,42,s-4*c*o/l),e.beginPath(),e.moveTo(50,s-4*c*o/l),e.lineTo(55,s-4*c*o/l),e.stroke()
for(var d=a;0>d;d+=.25)e.fillText(d,42,s-4*d*o/l),e.beginPath(),e.moveTo(50,s-4*d*o/l),e.lineTo(55,s-4*d*o/l),e.stroke()
timeAxis(e,t,r,s,i,o)}function timeAxis(e,t,i,n,a,o){if(240==a.length){e.font="24px Sans Serif",e.textAlign="left",e.fillStyle="#012c57"
var l=t.beginDate.slice(0,4),s=t.beginDate.slice(4,6),r=t.beginDate.slice(6,8),c=t.location
e.fillText("Tides for: "+c+" - "+s+"/"+r+"/"+l,52,20),e.font="15px Sans Serif",e.strokeStyle="#092643",e.fillStyle="#092643",e.textAlign="right"
for(var d=1;12>d;d++)e.beginPath(),e.moveTo(50+d*i/12,n),e.lineTo(65+d*i/12,n+15),e.stroke(),e.closePath(),e.beginPath(),e.arc(50+d*i/12,n,3,0,2*Math.PI,!0),e.closePath(),e.fill(),6>d?e.fillText(2*d+"AM",84+d*i/12,n+30):6==d?e.fillText(2*d+"PM",84+d*i/12,n+30):e.fillText(d%6*2+"PM",84+d*i/12,n+30)}else{e.font="24px Sans Serif",e.textAlign="left",e.fillStyle="#012c57"
var l=t.beginDate.slice(0,4),s=t.beginDate.slice(4,6),r=t.beginDate.slice(6,8),c=t.location
c.length>30&&(e.font="20px Sans Serif")
var p=t.endDate.slice(0,4),g=t.endDate.slice(4,6),f=t.endDate.slice(6,8)
e.fillText("Tides for: "+c+" - "+s+"/"+r+"/"+l+" to- "+g+"/"+f+"/"+p,52,20),e.font="15px Sans Serif",e.fillStyle="#092643"
var m=a.length/240
e.textAlign="right"
for(var u=0;m>u;u+=.5)e.beginPath(),e.moveTo(50+u*i/m,n),e.lineTo(55+u*i/m,n+15),e.stroke(),u%1==0?e.fillText("12AM",90+u*i/m,n+30):e.fillText("Noon",90+u*i/m,n+30)}}const SERVER="//45.33.68.196:8000"
$("#tideApp").append('    <div class="container" id="firstPage">      <div class="container" id="portSelection">        <h3>Choose port by selecting a map pin:</h3>      </div>      <div id="map"></div>          <div class="container" id="selectdate">            <h4>Choose between tides for one day and tides for multiple days:</h4>            <div class="row" id="selectors">                <p class="btn btn-info btn-sm" id="oneDay">Tides for one Day</p>                <p class="btn btn-info btn-sm" id="multDay">Tides for Multiple Days</p>                <ul class="pull-right">                  <p id="promptA">Choose Date: <input type="click" id="datepickerA"></p>                  <p id="promptB">Choose Start Date: <input type="click" id="datepickerB"></p>                  <p id="promptC">Choose End Date: <input type="click" id="datepickerC"></p>                </ul>            </div>            <p class="btn btn-info btn-sm" id="getTides">Get Tides</p>          </div>    </div>    <div class="container" id="secondPage">    <p class="btn btn-info btn-sm" id="returnBtn">Get More Tides</p>      <canvas width="750" height="550" id="tideCanvas"></canvas>    </div>'),$("body").append('  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpN0l_qaCwhVFOKjFIHDuEgtlOkrlFixQ&signed_in=true&callback=map">  </script>')
var coordinates=null,markers={},selectedKey=null,requestCache={},randomKey=function(e){var t=Object.keys(e)
return t[t.length*Math.random()<<0]}
const CACHE_MAX=10
var options=null,tideData=null
const PLOT_TIME=1
var first=!0,chartHeight=500,chartWidth=700,clearHeight=chartHeight+50,clearWidth=chartWidth+50,canvas=document.getElementById("tideCanvas"),context=canvas.getContext("2d"),stop=!1
Date.prototype.yyyymmdd=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),i=this.getDate().toString()
return e+(t[1]?t:"0"+t[0])+(i[1]?i:"0"+i[0])},Date.prototype.noaaDate=function(){var e=this.getHours().toString(),t=this.getMinutes().toString()
return this.yyyymmdd()+" "+(e[1]?e:"0"+e[0])+":"+(t[1]?t:"0"+t[0])}
var isMultipleDays=!1
$("#secondPage").hide(),$("#oneDay").on("click",function(){$("#multDay").toggle(300),$("#promptA").toggle(300),isMultipleDays=!1}),$("#multDay").on("click",function(){$("#oneDay").toggle(300),$("#promptB").toggle(300),$("#promptC").toggle(300),isMultipleDays=!0}),$("#promptA").hide(),$("#promptB").hide(),$("#promptC").hide(),$("#getTides").on("click",function(){if(null!==selectedKey){options={location:selectedKey,id:coordinates[selectedKey].id}
var e=!1
if(isMultipleDays){if(null!==$("#datepickerB").datepicker("getDate")&&null!==$("#datepickerC").datepicker("getDate")){options.beginDate=$("#datepickerB").datepicker("getDate").noaaDate(),options.endDate=$("#datepickerC").datepicker("getDate"),options.endDate.setHours(23),options.endDate.setMinutes(59),options.endDate=options.endDate.noaaDate()
var t=parseInt(options.beginDate.slice(6,8)),i=parseInt(options.endDate.slice(6,8)),n=parseInt(options.beginDate.slice(4,6)),a=parseInt(options.endDate.slice(4,6))
i>t&&7>=i-t&&a==n?e=!0:a-1==n&&6>=30-t+i?e=!0:alert("TidePlotter\n\nPlease select a valid date range no greater than 7 days.")}else alert("TidePlotter\n\nPlease select a begin date and an end date.")
options.interval="06"}else null!==$("#datepickerA").datepicker("getDate")?(options.beginDate=$("#datepickerA").datepicker("getDate").noaaDate(),options.endDate=$("#datepickerA").datepicker("getDate"),options.endDate.setHours(23),options.endDate.setMinutes(59),options.endDate=options.endDate.noaaDate(),options.interval="06",e=!0):alert("TidePlotter\nPlease choose a date.")
e&&(requestTides(options),$("#firstPage").slideUp(1e3),$("#secondPage").show())}else alert("TidePlotter\nPlease select a location from the map.")}),$("#returnBtn").on("click",function(){stop=!0,$("#firstPage").slideDown(),$("#secondPage").hide()}),$(function(){$("#datepickerA").datepicker()}),$(function(){$("#datepickerB").datepicker()}),$(function(){$("#datepickerC").datepicker()}),function(){for(var e=0,t=["ms","moz","webkit","o",""],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"]
window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var n=(new Date).getTime(),a=Math.max(0,16-(n-e)),o=window.setTimeout(function(){t(n+a)},a)
return e=n+a,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),function(){function e(){var e=Date.now()
n=(e-(i||e))/1e3,window.totalTime=window.totalTime+n,i=e}function t(){n=0,window.totalTime=0,i=null}var i=null,n=0
window.totalTime=0,window.updateDeltaTime=e,window.resetTime=t}()
