function map(){var e={lat:30.220552,lng:-91.600674},t=new google.maps.Map(document.getElementById("map"),{zoom:7,center:e,streetViewControl:!1})
$.getJSON("http://localhost:8000/locations.json",function(e){coordinates=e
for(var i in coordinates)markers[i]=new google.maps.Marker({position:coordinates[i].position,map:t,title:i,animation:google.maps.Animation.DROP})
for(var i in coordinates)google.maps.event.addListener(markers[i],"click",function(e){return function(){selectedKey!==e&&null!==selectedKey&&markers[selectedKey].setAnimation(null),null===markers[e].animation?(selectedKey=e,markers[e].setAnimation(google.maps.Animation.BOUNCE),document.getElementById("portSelection").innerHTML="<h3>You have selected: "+e+"</h3>"):(selectedKey=null,markers[e].setAnimation(null),document.getElementById("portSelection").innerHTML="<h3>Choose port by selecting a map pin:</h3>")}}(i))})}function requestTides(){if(console.log("Hello!"),context.clearRect(0,0,clearWidth,clearHeight),context.fillStyle="#ffffff",context.fillRect(0,0,clearWidth,clearHeight),context.fillStyle="#000000",context.font="18px Sans Serif",context.textAlign="left",context.fillText("Loading...",325,225),!requestCache[options.location+options.beginDate+options.endDate]){for(;Object.keys(requestCache).length>=CACHE_MAX;)console.log("Removing a cached request..."),delete requestCache[randomKey(requestCache)]
requestCache[options.location+options.beginDate+options.endDate]=$.ajax({type:"POST",url:"http://localhost:8000/tides",contentType:"application/json",crossDomain:!0,data:JSON.stringify(options),dataType:"json"}).promise()}requestCache[options.location+options.beginDate+options.endDate].done(function(e,t,i){var n=JSON.parse(i.responseText)
tideData=n["soapenv:Envelope"]["soapenv:Body"][0].PredictionsAndMetadata[0].data[0].item,first=!0,stop=!1,getCanvas()}),requestCache[options.location+options.beginDate+options.endDate].fail(function(e){console.log("ERROR:",e)})}function getCanvas(){first&&(first=!1,resetTime()),updateDeltaTime(),stop?(tideData=null,options=null):(requestAnimationFrame(getCanvas),getMax(context,options,tideData))}function getMax(e,t,n){var o=.5,a=-.25
for(i in n)n[i].pred>o&&(o=Math.round(4*n[i].pred)/4+.25),n[i].pred<a&&(a=Math.round(4*n[i].pred)/4-.25)
drawAxis(e,t,n,o,a)}function drawAxis(e,t,i,n,o){var a=(n-o)/.25
e.clearRect(0,0,clearWidth,clearHeight)
for(var l=0;a>l;l++)l%2==0?e.fillStyle="#e8f8ff":e.fillStyle="#fbfdfb",e.fillRect(51,l*chartHeight/a+25,chartWidth,chartHeight/a)
var r=chartHeight*n/(.25*a)+25
e.beginPath(),e.moveTo(50,25),e.lineTo(50,chartHeight+25),e.moveTo(50,r),e.lineTo(chartWidth+50,r),e.lineWidth=2,e.strokeStyle="#092643",e.stroke(),plotData(e,t,i,chartHeight,chartWidth,r,a,n,o)}function plotData(e,t,i,n,o,a,l,r,s){var d=totalTime/PLOT_TIME
d>=1&&(d=1)
var c=d*i.length,p=i.length
e.strokeStyle="black",e.beginPath(),e.moveTo(51,a-4*i[0].pred*500/l),j=0,e.fillStyle="#a0abb6"
for(var g=0;c>g;g++)e.lineTo(o/p*j+51,a-4*i[g].pred*500/l),e.stroke(),e.fillRect(o/p*j+51,a-4*i[g].pred*500/l,3,4*i[g].pred*500/l-1),j++
labelAxis(e,t,i,r,s,n,l,a,o)}function labelAxis(e,t,i,n,o,a,l,r,s){e.fillStyle="#092643",e.font="17px Sans Serif",e.fillText("Feet",60,60),e.font="16px Sans Serif",e.textAlign="right",e.strokeStyle="#092643"
for(var d=0;n>=d;d+=.25)e.fillText(d,42,r-4*d*a/l),e.beginPath(),e.moveTo(50,r-4*d*a/l),e.lineTo(55,r-4*d*a/l),e.stroke()
for(var c=o;0>c;c+=.25)e.fillText(c,42,r-4*c*a/l),e.beginPath(),e.moveTo(50,r-4*c*a/l),e.lineTo(55,r-4*c*a/l),e.stroke()
timeAxis(e,t,s,r,i,a)}function timeAxis(e,t,i,n,o,a){if(240==o.length){e.font="24px Sans Serif",e.textAlign="left",e.fillStyle="#012c57"
var l=t.beginDate.slice(0,4),r=t.beginDate.slice(4,6),s=t.beginDate.slice(6,8),d=t.location
e.fillText("Tides for: "+d+" - "+r+"/"+s+"/"+l,52,20),e.font="15px Sans Serif",e.strokeStyle="#092643",e.fillStyle="#092643",e.textAlign="right"
for(var c=1;12>c;c++)e.beginPath(),e.moveTo(50+c*i/12,n),e.lineTo(65+c*i/12,n+15),e.stroke(),e.closePath(),e.beginPath(),e.arc(50+c*i/12,n,3,0,2*Math.PI,!0),e.closePath(),e.fill(),6>c?e.fillText(2*c+"AM",84+c*i/12,n+30):6==c?e.fillText(2*c+"PM",84+c*i/12,n+30):e.fillText(c%6*2+"PM",84+c*i/12,n+30)}else{e.font="24px Sans Serif",e.textAlign="left",e.fillStyle="#012c57"
var l=t.beginDate.slice(0,4),r=t.beginDate.slice(4,6),s=t.beginDate.slice(6,8),d=t.location
console.log(d.length),d.length>30&&(e.font="20px Sans Serif")
var p=t.endDate.slice(0,4),g=t.endDate.slice(4,6),f=t.endDate.slice(6,8)
e.fillText("Tides for: "+d+" - "+r+"/"+s+"/"+l+" to- "+g+"/"+f+"/"+p,52,20),e.font="15px Sans Serif",e.fillStyle="#092643"
var h=o.length/240
e.textAlign="right"
for(var m=0;h>m;m+=.5)e.beginPath(),e.moveTo(50+m*i/h,n),e.lineTo(55+m*i/h,n+15),e.stroke(),m%1==0?e.fillText("12AM",90+m*i/h,n+30):e.fillText("Noon",90+m*i/h,n+30)}}$("head").append("    <style>      html, body {        height: 100%;        margin: 50px;        padding: 0;      }      #map {        height: 350px; width: 750px;        padding-left: 0;        padding-right: 0;        margin-left: auto;        margin-right: auto;        display: block;    border-left:solid;    border-right:solid;    border-color: #49796b;      }    #selectdate {    background-color: #a0d6b4;    height: auto;    width:750px;    display: block;    margin-left: auto;        margin-right: auto;    border:solid;    border-color: #49796b;    }    #selectors {margin-left: auto; margin-right: auto;}    #selectdate {padding-bottom: 5px;}    #getTides {float:right;}    #portSelection{    border:solid;    height: auto;    width:750px;    display: block;    margin-left: auto;    margin-right: auto;    border-color:#49796b;    background-color: #a0d6b4;    }    #getTides {background:#49796b;} #oneDay {background:#49796b;} #multDay {background:#49796b;}    #chooseLocation {background:#49796b;}    #tideCanvas {margin-left: 200px;}    </style>"),$("#tideApp").append('    <div class="container" id="firstPage">      <div class="container" id="portSelection">        <h3>Choose port by selecting a map pin:</h3>      </div>      <div id="map"></div>          <div class="container" id="selectdate">            <h4>Choose between tides for one day and tides for multiple days:</h4>            <div class="row" id="selectors">                <p class="btn btn-info btn-sm" id="oneDay">Tides for one Day</p>                <p class="btn btn-info btn-sm" id="multDay">Tides for Multiple Days</p>                <ul class="pull-right">                  <p id="promptA">Choose Date: <input type="click" id="datepickerA"></p>                  <p id="promptB">Choose Start Date: <input type="click" id="datepickerB"></p>                  <p id="promptC">Choose End Date: <input type="click" id="datepickerC"></p>                </ul>            </div>            <p class="btn btn-info btn-sm" id="getTides">Get Tides</p>          </div>    </div>    <div class="container" id="secondPage">    <p class="btn btn-info btn-sm" id="returnBtn">Get More Tides</p>      <canvas width="750" height="550" id="tideCanvas"></canvas>    </div>'),$("body").append('  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpN0l_qaCwhVFOKjFIHDuEgtlOkrlFixQ&signed_in=true&callback=map">  </script>')
var coordinates=null,markers={},selectedKey=null,requestCache={},randomKey=function(e){var t=Object.keys(e)
return t[t.length*Math.random()<<0]}
const CACHE_MAX=10
var options=null,tideData=null
const PLOT_TIME=1
var first=!0,chartHeight=500,chartWidth=700,clearHeight=chartHeight+50,clearWidth=chartWidth+50,canvas=document.getElementById("tideCanvas"),context=canvas.getContext("2d"),stop=!1
Date.prototype.yyyymmdd=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),i=this.getDate().toString()
return e+(t[1]?t:"0"+t[0])+(i[1]?i:"0"+i[0])},Date.prototype.noaaDate=function(){var e=this.getHours().toString(),t=this.getMinutes().toString()
return this.yyyymmdd()+" "+(e[1]?e:"0"+e[0])+":"+(t[1]?t:"0"+t[0])}
var isMultipleDays=!1
$("#secondPage").hide(),$("#oneDay").on("click",function(){$("#multDay").toggle(300),$("#promptA").toggle(300),isMultipleDays=!1}),$("#multDay").on("click",function(){$("#oneDay").toggle(300),$("#promptB").toggle(300),$("#promptC").toggle(300),isMultipleDays=!0}),$("#promptA").hide(),$("#promptB").hide(),$("#promptC").hide(),$("#getTides").on("click",function(){if(null!==selectedKey){options={location:selectedKey,id:coordinates[selectedKey].id}
var e=!1
if(isMultipleDays){if(null!==$("#datepickerB").datepicker("getDate")&&null!==$("#datepickerC").datepicker("getDate")){options.beginDate=$("#datepickerB").datepicker("getDate").noaaDate(),options.endDate=$("#datepickerC").datepicker("getDate"),options.endDate.setHours(23),options.endDate.setMinutes(59),options.endDate=options.endDate.noaaDate()
var t=parseInt(options.beginDate.slice(6,8)),i=parseInt(options.endDate.slice(6,8)),n=parseInt(options.beginDate.slice(4,6)),o=parseInt(options.endDate.slice(4,6))
i>t&&7>=i-t&&o==n?e=!0:o-1==n&&6>=30-t+i?e=!0:alert("TidePlotter\n\nPlease select a valid date range no greater than 7 days.")}else alert("TidePlotter\n\nPlease select a begin date and an end date.")
options.interval="06"}else null!==$("#datepickerA").datepicker("getDate")?(options.beginDate=$("#datepickerA").datepicker("getDate").noaaDate(),options.endDate=$("#datepickerA").datepicker("getDate"),options.endDate.setHours(23),options.endDate.setMinutes(59),options.endDate=options.endDate.noaaDate(),options.interval="06",e=!0):alert("TidePlotter\nPlease choose a date.")
e&&(requestTides(options),$("#firstPage").slideUp(1e3),$("#secondPage").show())}else alert("TidePlotter\nPlease select a location from the map.")}),$("#returnBtn").on("click",function(){stop=!0,$("#firstPage").slideDown(),$("#secondPage").hide()}),$(function(){$("#datepickerA").datepicker()}),$(function(){$("#datepickerB").datepicker()}),$(function(){$("#datepickerC").datepicker()}),function(){for(var e=0,t=["ms","moz","webkit","o",""],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"]
window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var n=(new Date).getTime(),o=Math.max(0,16-(n-e)),a=window.setTimeout(function(){t(n+o)},o)
return e=n+o,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),function(){function e(){var e=Date.now()
n=(e-(i||e))/1e3,window.totalTime=window.totalTime+n,i=e}function t(){n=0,window.totalTime=0,i=null}var i=null,n=0
window.totalTime=0,window.updateDeltaTime=e,window.resetTime=t}()
