function map(){$.getJSON(SERVER+"/locations?state="+STATE,function(e){var t=new google.maps.Map(document.getElementById("map"),{zoom:7,center:e.coordinates,streetViewControl:!1})
coordinates={}
var a=null
for(var i in e.locations)a=e.locations[i].name,coordinates[a]={id:e.locations[i].stationId,position:{lat:e.locations[i].lat,lng:e.locations[i].lng}},markers[a]=new google.maps.Marker({position:coordinates[a].position,map:t,title:a,animation:google.maps.Animation.DROP})
for(var a in coordinates)google.maps.event.addListener(markers[a],"click",function(e){return function(){selectedKey!==e&&null!==selectedKey&&markers[selectedKey].setAnimation(null),null===markers[e].animation?(selectedKey=e,markers[e].setAnimation(google.maps.Animation.BOUNCE),document.getElementById("portSelection").innerHTML="<h3>You have selected: "+e+"</h3>"):(selectedKey=null,markers[e].setAnimation(null),document.getElementById("portSelection").innerHTML="<h3>Choose port by selecting a map pin:</h3>")}}(a))})}function requestTides(){if(context.clearRect(0,0,clearWidth,clearHeight),context.fillStyle="#ffffff",context.fillRect(0,0,clearWidth,clearHeight),context.fillStyle="#000000",context.font="18px Sans Serif",context.textAlign="center",context.fillText("Loading...",.5*chartHeight,.5*chartWidth),!requestCache[options.location+options.beginDate+options.endDate]){for(;Object.keys(requestCache).length>=CACHE_MAX;)console.log("Removing a cached request..."),delete requestCache[randomKey(requestCache)]
requestCache[options.location+options.beginDate+options.endDate]=$.ajax({type:"POST",url:SERVER+"/tides",contentType:"application/json",crossDomain:!0,data:JSON.stringify(options),dataType:"json"}).promise()}requestCache[options.location+options.beginDate+options.endDate].done(function(e,t,a){var i=JSON.parse(a.responseText)
tideData=i["soapenv:Envelope"]["soapenv:Body"][0].PredictionsAndMetadata[0].data[0].item,first=!0,stop=!1,getCanvas()}),requestCache[options.location+options.beginDate+options.endDate].fail(function(e){console.log("ERROR:",e)})}function getCanvas(){first&&(first=!1,resetTime()),updateDeltaTime(),stop?(tideData=null,options=null):(requestAnimationFrame(getCanvas),getMax(context,options,tideData))}function getMax(e,t,a){var n=.5,o=-.25
for(i in a)a[i].pred>n&&(n=Math.round(4*a[i].pred)/4+.25),a[i].pred<o&&(o=Math.round(4*a[i].pred)/4-.25)
drawAxis(e,t,a,n,o)}function drawAxis(e,t,a,i,n){var o=(i-n)/.25
e.clearRect(0,0,clearWidth,clearHeight)
for(var r=0;o>r;r++)r%2==0?e.fillStyle="#e8f8ff":e.fillStyle="#fbfdfb",e.fillRect(leftMarg+1,r*chartHeight/o+topMarg,chartWidth,chartHeight/o)
var l=chartHeight*i/(.25*o)+topMarg
e.beginPath(),e.moveTo(leftMarg,topMarg),e.lineTo(leftMarg,chartHeight+topMarg),e.moveTo(leftMarg,l),e.lineTo(chartWidth+leftMarg,l),e.lineWidth=2,e.strokeStyle="#092643",e.stroke(),plotData(e,t,a,chartHeight,chartWidth,l,o,i,n)}function plotData(e,t,a,i,n,o,r,l,s){var c=totalTime/PLOT_TIME
c>=1&&(c=1)
var d=c*a.length,p=a.length
e.strokeStyle="black",e.lineWidth=1,e.beginPath(),e.moveTo(leftMarg+1,o-4*a[0].pred*i/r),j=0,e.fillStyle="#a0abb6"
for(var g=0;d>g;g++)e.lineTo(n/p*j+leftMarg+1,o-4*a[g].pred*i/r),e.stroke(),e.fillRect(n/p*j+leftMarg+1,o-4*a[g].pred*i/r,1,4*a[g].pred*i/r-1),j++
labelAxis(e,t,a,l,s,i,r,o,n)}function labelAxis(e,t,a,i,n,o,r,l,s){e.fillStyle="#092643",e.font="17px Sans Serif",e.fillText("Feet",1.8*leftMarg,2.5*topMarg),e.font="14px Sans Serif",e.textAlign="right",e.strokeStyle="black"
for(var c=0;i>=c;c+=.25)e.fillText(c,leftMarg-8,l-4*c*o/r+.2*topMarg),e.beginPath(),e.moveTo(leftMarg,l-4*c*o/r),e.lineTo(leftMarg+.1*leftMarg,l-4*c*o/r),e.stroke()
for(var d=n;0>d;d+=.25)e.fillText(d,leftMarg-8,l-4*d*o/r),e.beginPath(),e.moveTo(leftMarg,l-4*d*o/r),e.lineTo(leftMarg+.1*leftMarg,l-4*d*o/r),e.stroke()
timeAxis(e,t,s,l,a,o)}function timeAxis(e,t,a,i,n,o){if(240==n.length){e.font="12px Sans Serif",e.strokeStyle="#092643",e.fillStyle="#092643",e.textAlign="center"
for(var r=1;12>r;r++)e.beginPath(),e.moveTo(leftMarg+r*a/12,i),e.lineTo(leftMarg+.32*leftMarg+r*a/12,i+.6*topMarg),e.stroke(),e.closePath(),e.beginPath(),e.arc(leftMarg+r*a/12,i,3,0,2*Math.PI,!0),e.closePath(),e.fill(),6>r?e.fillText(2*r+"AM",1.6*leftMarg+r*a/12,i+1.2*topMarg):6==r?e.fillText(2*r+"PM",1.6*leftMarg+r*a/12,i+1.2*topMarg):e.fillText(r%6*2+"PM",1.6*leftMarg+r*a/12,i+1.2*topMarg)}else{e.font="12px Sans Serif",e.fillStyle="#092643"
var l=n.length/240
e.textAlign="center"
for(var s=0;l>s;s+=.5)e.beginPath(),e.moveTo(leftMarg+s*a/l,i),e.lineTo(leftMarg+.2*leftMarg+s*a/l,i+.6*topMarg),e.stroke(),e.closePath(),e.beginPath(),e.arc(leftMarg+s*a/l,i,3,0,2*Math.PI,!0),e.closePath(),e.fill(),s%1==0?e.fillText("12AM",1.5*leftMarg+s*a/l,i+1.2*topMarg):e.fillText("Noon",1.5*leftMarg+s*a/l,i+1.2*topMarg)}}const SERVER="//45.33.68.196:80"
$("#tideApp").append('    <div class="container" id="app">      <div class="container" id="portSelection">        <h3>Choose port by selecting a map pin:</h3>      </div>      <div id="map"></div>	  <div id="plotter"><canvas width="540" height="400" id="tideCanvas"></canvas></div>	  <div class="container" id="selectdate">		<div class="row" id="selectors">			<p class="btn btn-info btn-sm" id="oneDay">Tides for one Day</p>			<p class="btn btn-info btn-sm" id="multDay">Tides for Multiple Days</p>			<ul class="pull-right" id="daters">			  <p id="promptA"> Date: <input type="click" id="datepickerA"></p>			  <p id="promptB"> Start Date: <input type="click" id="datepickerB"></p>			  <p id="promptC"> End Date:  <input type="click" id="datepickerC"></p>			</ul>		</div>		<p class="btn btn-info btn-sm" id="getTides">Get Tides</p>		<p class="btn btn-info btn-sm" id="returnBtn">Select New Location</p>	  </div>    </div>'),$("body").append('  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpN0l_qaCwhVFOKjFIHDuEgtlOkrlFixQ&signed_in=true&callback=map">  </script>')
var coordinates=null,markers={},selectedKey=null,requestCache={},randomKey=function(e){var t=Object.keys(e)
return t[t.length*Math.random()<<0]}
const CACHE_MAX=10
var options=null,tideData=null
const PLOT_TIME=1
var first=!0,chartHeight=350,chartWidth=490,leftMarg=.0714*chartWidth,topMarg=chartHeight/18,clearHeight=chartHeight+topMarg,clearWidth=chartWidth+leftMarg,canvas=document.getElementById("tideCanvas"),context=canvas.getContext("2d"),stop=!1
Date.prototype.yyyymmdd=function(){var e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),a=this.getDate().toString()
return e+(t[1]?t:"0"+t[0])+(a[1]?a:"0"+a[0])},Date.prototype.noaaDate=function(){var e=this.getHours().toString(),t=this.getMinutes().toString()
return this.yyyymmdd()+" "+(e[1]?e:"0"+e[0])+":"+(t[1]?t:"0"+t[0])}
var isMultipleDays=!1
$("#plotter").hide(),$("#returnBtn").hide(),$("#oneDay").on("click",function(){$("#multDay").toggle(300),$("#promptA").toggle(300),isMultipleDays=!1}),$("#multDay").on("click",function(){$("#oneDay").toggle(300),$("#promptB").toggle(300),$("#promptC").toggle(300),isMultipleDays=!0}),$("#promptA").hide(),$("#promptB").hide(),$("#promptC").hide(),$("#getTides").on("click",function(){if(null!==selectedKey){options={location:selectedKey,id:coordinates[selectedKey].id}
var e=!1
if(isMultipleDays){if(null!==$("#datepickerB").datepicker("getDate")&&null!==$("#datepickerC").datepicker("getDate")){options.beginDate=$("#datepickerB").datepicker("getDate").noaaDate(),options.endDate=$("#datepickerC").datepicker("getDate"),options.endDate.setHours(23),options.endDate.setMinutes(59),options.endDate=options.endDate.noaaDate()
var t=parseInt(options.beginDate.slice(6,8)),a=parseInt(options.endDate.slice(6,8)),i=parseInt(options.beginDate.slice(4,6)),n=parseInt(options.endDate.slice(4,6))
a>t&&7>=a-t&&n==i?e=!0:n-1==i&&6>=30-t+a?e=!0:alert("TidePlotter\n\nPlease select a valid date range no greater than 7 days.")}else alert("TidePlotter\n\nPlease select a begin date and an end date.")
options.interval="06"}else null!==$("#datepickerA").datepicker("getDate")?(options.beginDate=$("#datepickerA").datepicker("getDate").noaaDate(),options.endDate=$("#datepickerA").datepicker("getDate"),options.endDate.setHours(23),options.endDate.setMinutes(59),options.endDate=options.endDate.noaaDate(),options.interval="06",e=!0):alert("TidePlotter\nPlease choose a date.")
e&&(requestTides(options),$("#map").hide(),$("#plotter").show(),$("#returnBtn").show(300))}else alert("TidePlotter\nPlease select a location from the map.")}),$("#returnBtn").on("click",function(){stop=!0,$("#map").show(),$("#plotter").hide(),$("#returnBtn").hide(300)}),$(function(){$("#datepickerA").datepicker()}),$(function(){$("#datepickerB").datepicker()}),$(function(){$("#datepickerC").datepicker()}),function(){for(var e=0,t=["ms","moz","webkit","o",""],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"]
window.requestAnimationFrame||(window.requestAnimationFrame=function(t,a){var i=(new Date).getTime(),n=Math.max(0,16-(i-e)),o=window.setTimeout(function(){t(i+n)},n)
return e=i+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),function(){function e(){var e=Date.now()
i=(e-(a||e))/1e3,window.totalTime=window.totalTime+i,a=e}function t(){i=0,window.totalTime=0,a=null}var a=null,i=0
window.totalTime=0,window.updateDeltaTime=e,window.resetTime=t}()
